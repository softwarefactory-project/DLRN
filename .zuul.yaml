---
- job:
    name: dlrn-base
    parent: base
    pre-run:
      - playbooks/start-tracer.yaml
      - playbooks/prepare.yaml
    post-run:
      - playbooks/retrieve-logs.yaml
      - playbooks/stop-tracer.yaml
    irrelevant-files:
      - ^doc/.*$
    nodeset:
      nodes:
        - name: test-node
          label: cloud-centos-7
    roles:
      - zuul: software-factory/ci-tracer

- job:
    name: dlrn-rpmbuild
    parent: dlrn-base
    description: Run DLRN to build a package
    run: playbooks/rpmbuild.yaml

- job:
    name: dlrn-rpmbuild-python3
    parent: dlrn-base
    description: Run DLRN to build a package using Python 3
    run: playbooks/rpmbuild.yaml
    vars:
      python_version: py36
    nodeset:
      nodes:
        - name: testrunner
          label: rdo-fedora-28

- job:
    name: dlrn-rpmbuild-tripleo-ci-oooq
    parent: dlrn-base
    voting: false
    description: Run DLRN to build a package using Tripleo-Quickstart playbooks
    run: playbooks/tripleo-ci-oooq.yaml
    post-run: playbooks/tripleo-ci-oooq-getlogs.yaml

- job:
    name: dlrn-rpmbuild-tripleo-ci-oooq-rhel8
    parent: dlrn-rpmbuild-tripleo-ci-oooq
    nodeset:
      nodes:
        - name: test-node-rhel-8
          label: cloud-fedora-30
    host-vars:
      localhost:
        ansible_python_interpreter: /usr/bin/python3
      test-node-rhel-8:
        ansible_python_interpreter: /usr/bin/python3
    description: Run DLRN to build a package using Tripleo-Quickstart playbooks on RHEL 8

- job:
    name: dlrn-api-functional
    parent: dlrn-base
    voting: false
    description: Run a DLRN functional test, using the API and dlrnapi_client
    run: playbooks/dlrn-api-functional.yaml
    post-run: playbooks/dlrn-api-functional-getlogs.yaml
    required-projects:
      - DLRN
      - dlrnapi_client

- project:
    name: DLRN
    vars:
      rtd_webhook_id: '101768'
      rtd_project_name: 'dlrn'
    check:
      jobs:
        - dlrn-rpmbuild-tripleo-ci-oooq-rhel8
    gate:
      jobs:
        - tox-pep8
        - tox-py27
        - tox-py36:
            nodeset:
              nodes:
                - name: testrunner
                  label: fedora-oci
        - dlrn-rpmbuild
        - dlrn-rpmbuild-python3
    post:
      jobs:
        - publish-readthedocs
    release:
      jobs:
        - upload-pypi
        - publish-readthedocs
