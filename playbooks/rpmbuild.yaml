---
- hosts: all
  tasks:
    - name: Set facts for CentOS 7, we will use stable/train
      set_fact:
        tag: 'train'
        centos_version: 'centos7'
      when:
        - ansible_distribution == "CentOS"
        - ansible_distribution_major_version | int == 7

    - name: Set facts for CentOS 8, we will use master
      set_fact:
        tag: ''
        centos_version: centos8
      when:
        - ansible_distribution == "CentOS"
        - ansible_distribution_major_version | int == 8

    - name: Build package
      shell:
        cmd: |
          export TAG="{{  tag | default('') }}"
          export CENTOS_VERS="{{  centos_version }}"
          export REPO_SERVER="https://trunk.rdoproject.org"
          if [ ${CENTOS_VERS} = "centos8" ]; then
             export TARGET="centos8"
          else
              export TARGET="centos"
          fi
          if [ -z "$TAG" ];then
              ARGS="$TARGET ${REPO_SERVER}/${CENTOS_VERS}/"
          else
              ARGS="$TARGET ${REPO_SERVER}/${CENTOS_VERS}/ $TAG"
          fi
          export PYTHON_VERSION="{{ python_version | default('py27') }}"
          timeout --signal=SIGKILL 3600 ./scripts/run_tests.sh http://review.rdoproject.org/r/p/rdoinfo.git $ARGS
      args:
        chdir: "{{ ansible_user_dir }}/{{ zuul.projects['softwarefactory-project.io/DLRN'].src_dir }}"
